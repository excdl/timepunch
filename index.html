<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>奇可智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
/* 基本樣式同你原本的CSS，可保留 */
body { font-family: Arial; display:flex; justify-content:center; padding:20px; background:#f5f6fa; margin:0;}
#controlPanel { background:white; padding:25px 20px; border-radius:15px; box-shadow:0 8px 20px rgba(0,0,0,0.1); width:95%; max-width:500px; display:flex; flex-direction:column; gap:20px; align-items:center; box-sizing:border-box;}
.buttons-container { display:flex; gap:10px; width:100%; flex-wrap:nowrap;}
.buttons-container button { flex:1 1 0; min-width:80px; padding:10px 0; font-size:25px; border-radius:8px; cursor:pointer; font-weight:bold; border:none;}
#btnStart { background: linear-gradient(145deg, #3498db, #2980b9); color:white; } 
#btnEnd { background: linear-gradient(145deg, #2ecc71, #27ae60); color:white; }   
#btnMakeup { background: linear-gradient(145deg, #f39c12, #d35400); color:white; } 
#btnManager { background: linear-gradient(145deg,#8e44ad,#663399); color:white; width:100%; padding:12px 0; border-radius:10px; border:none; cursor:pointer; font-size:18px; font-weight:bold;}
#statusInfo, #dateTime, #userInfo { text-align:center; width:100%; }
</style>
</head>
<body>
<div id="controlPanel">
    <div id="userInfo">正在獲取使用者資訊...</div>
    <div id="statusInfo"></div>
    <div id="dateTime">載入中…</div>

    <div class="buttons-container">
        <button id="btnStart">上班</button>
        <button id="btnEnd">下班</button>
        <button id="btnMakeup">補打卡</button>
    </div>

    <button id="btnManager">管理者登錄</button>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/YOUR_DEPLOY_ID/exec"; 
let registeredIPs = []; // 由管理者註冊時寫入的IP

// 更新日期時間
function updateDateTime(){ const now = new Date(); document.getElementById("dateTime").textContent = now.toLocaleString("zh-TW",{hour12:false}); }
setInterval(updateDateTime,1000); updateDateTime();

async function getIP(){ try{ const res=await fetch("https://api.ipify.org?format=json"); const data=await res.json(); return data.ip;}catch{return "";}}

// 更新使用者資訊
async function updateUserInfo(){
    if(!liff.isLoggedIn()){ await liff.login(); }
    await liff.init({liffId:"YOUR_LIFF_ID"});
    const profile = await liff.getProfile();
    window.userId = profile.userId;
    window.userName = profile.displayName;
    document.getElementById("userInfo").textContent = `${window.userName} 您好`;

    // 讀取已註冊管理者IP
    const ipRes = await fetch(`${API_ENDPOINT}?action=getManagerIPs`);
    registeredIPs = await ipRes.json();
}

updateUserInfo();

// 打卡
async function performClockIn(status){
    const ip = await getIP();
    if(!registeredIPs.includes(ip)){
        Swal.fire({icon:"error", title:"非公司網路無法打卡"});
        return;
    }
    const res = await fetch(API_ENDPOINT,{method:"POST", body:JSON.stringify({userId:window.userId, displayName:window.userName, status, ip, isMakeup:false})});
    const data = await res.json();
    Swal.fire({icon:"success", title:data.message, html:`${data.date} ${data.time}`});
}

// 補打卡
document.getElementById("btnMakeup").onclick = async ()=>{
    const { value, isConfirmed } = await Swal.fire({
        title:"補打卡設定",
        html:`<input type="date" id="d"><input type="time" id="t"><select id="s"><option value="">選擇狀態</option><option value="上班">上班</option><option value="下班">下班</option></select>`,
        showCancelButton:true, confirmButtonText:"完成"
    });
    if(isConfirmed){
        const d = document.getElementById("d").value;
        const t = document.getElementById("t").value;
        const s = document.getElementById("s").value;
        if(!d||!t||!s){ Swal.showValidationMessage("請填寫完整"); return; }
        const ip = await getIP();
        if(!registeredIPs.includes(ip)){ Swal.fire({icon:"error", title:"非公司網路無法打卡"}); return; }
        await fetch(API_ENDPOINT,{method:"POST", body:JSON.stringify({userId:window.userId, displayName:window.userName, status:s, ip, isMakeup:true, customDate:d, customTime:t})});
        Swal.fire({icon:"success", title:"補打卡成功"});
    }
}

// 上下班
document.getElementById("btnStart").onclick = ()=>performClockIn("上班");
document.getElementById("btnEnd").onclick = ()=>performClockIn("下班");

// 管理者註冊
document.getElementById("btnManager").onclick = async ()=>{
    const { value:step1, isConfirmed } = await Swal.fire({
        title:"輸入固定帳密",
        html:`<input type="text" id="adminAcc" placeholder="帳號" value="admin"><input type="text" id="adminPwd" placeholder="固定16位英數密碼">`,
        showCancelButton:true, confirmButtonText:"下一步",
        preConfirm:()=>{ const a=document.getElementById("adminAcc").value; const b=document.getElementById("adminPwd").value; if(a!=="admin"||!/^[A-Za-z0-9]{16}$/.test(b)) Swal.showValidationMessage("帳號或密碼錯誤"); return [a,b]; }
    });
    if(!isConfirmed) return;
    const { value:step2, isConfirmed:isConfirm2 } = await Swal.fire({
        title:"註冊管理者帳號",
        html:`<input type="text" id="newAcc" placeholder="新帳號"><input type="text" id="newPwd" placeholder="8位英數密碼">`,
        showCancelButton:true, confirmButtonText:"完成",
        preConfirm:()=>{ const a=document.getElementById("newAcc").value; const b=document.getElementById("newPwd").value; if(!/^[A-Za-z0-9]{8}$/.test(b)||!a) Swal.showValidationMessage("請輸入正確資料"); return [a,b]; }
    });
    if(!isConfirm2) return;

    const ip = await getIP();
    await fetch(API_ENDPOINT,{method:"POST", body:JSON.stringify({
        action:"registerManager",
        adminAcc:step1[0],
        adminPwd:step1[1],
        newAcc:step2[0],
        newPwd:step2[1],
        userId:window.userId,
        ip:ip
    })});
    Swal.fire({icon:"success", title:"註冊完成"});
}
</script>
</body>
</html>









