<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>奇可智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
/* CSS 與你原本保持一致 */
body { font-family: Arial; display:flex; justify-content:center; padding:20px; background:#f5f6fa; margin:0;}
#controlPanel { background:white; padding:25px 20px; border-radius:15px; box-shadow:0 8px 20px rgba(0,0,0,0.1); width:95%; max-width:500px; display:flex; flex-direction:column; gap:20px; align-items:center; box-sizing:border-box;}
#userInfo { text-align:center; font-size:26px; font-weight:bold; }
#statusInfo { text-align:center; font-size:23px; padding:5px 15px; border-radius:20px; display:inline-block; }
#dateTime { text-align:center; font-size:22px; }
.buttons-container { display:flex; gap:10px; width:100%; flex-wrap:nowrap; }
.buttons-container button { flex:1 1 0; min-width:80px; padding:10px 0; font-size:25px; border-radius:8px; cursor:pointer; font-weight:bold; border:none; white-space:nowrap; transition: all 0.2s ease;}
.buttons-container button:hover{ transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1);}
.buttons-container button:active{ transform: translateY(1px); box-shadow: 0 2px 4px rgba(0,0,0,0.08);}
#btnStart { background: linear-gradient(145deg, #3498db, #2980b9); color:white; } 
#btnEnd { background: linear-gradient(145deg, #2ecc71, #27ae60); color:white; }   
#countdownWrapper { width:120px; height:120px; position:relative; display:none; }
#circleProgress { fill:none; stroke-width:12; stroke-linecap:round; transform: rotate(-90deg); transform-origin: 50% 50%; }
#countdownText { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:bold; white-space:nowrap; }
#querySection { width:100%; display:flex; flex-direction:column; gap:10px; }
#querySection .queryRow { display:flex; gap:10px; width:100%; flex-wrap:nowrap; align-items:center; }
#querySection input[type="date"] { flex:1 1 auto; min-width:100px; padding:8px 10px; font-size:14px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
#querySection button { flex:1 1 0; padding:8px 0; font-size:14px; font-weight:bold; border-radius:6px; border:none; cursor:pointer; white-space:nowrap; }
#btnQuery { background:#d3d3d3; color:black; }  
#btnReturn { background:#d3d3d3; color:black; }  
#todayRecords { border:1px solid #ccc; border-radius:8px; padding:10px; min-height:50px; font-size:16px; background: #fafafa; width:100%; box-sizing:border-box; }
#btnApprove { margin-top:10px; padding:12px 20px; font-size:18px; font-weight:bold; border-radius:10px; background:linear-gradient(145deg,#8e44ad,#663399); color:white; display:none; width:100%; cursor:pointer; border:none; }
#btnApprove:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1);}
@media(max-width:400px){ .buttons-container button{ font-size:20px; } #querySection input[type="date"]{ font-size:13px; } #querySection button{ font-size:13px; } }
</style>
</head>
<body>
<div id="controlPanel">
    <div id="userInfo">正在獲取使用者資訊...</div>
    <div id="statusInfo"></div>
    <div id="dateTime">載入中…</div>

    <div class="buttons-container">
        <button id="btnStart">上班</button>
        <button id="btnEnd">下班</button>
    </div>

    <div id="countdownWrapper">
        <svg width="120" height="120">
            <circle id="circleProgress" cx="60" cy="60" r="50"></circle>
        </svg>
        <div id="countdownText">打卡中...</div>
    </div>

    <div id="querySection">
        <div class="queryRow">
            <input type="date" id="queryDate">
            <button id="btnQuery" onclick="searchDateRecords()">查詢</button>
            <button id="btnReturn" onclick="clearSearch()">返回</button>
        </div>
        <div id="todayRecords">今日打卡紀錄：</div>
    </div>

    <button id="btnApprove">管理者設定</button>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbwROFtlO9-_EpNrBjH7aRoKiBDRdj0UY-S1oZ8HrUh2sNy5OBbi4TRNtptc0kgBrxDslg/exec";

const MANAGER_ACCOUNT = "admin";
const MANAGER_PASSWORD = "Ab1Cd2Ef3Gh4Ij5K";
const MANAGER_NEED_CHANGE = true;

const btnStart = document.getElementById("btnStart");
const btnEnd = document.getElementById("btnEnd");
btnStart.disabled = true; btnEnd.disabled = true;
window.userReady = false;
let allowedIPs = [];

function updateDateTime() {
    const now = new Date();
    document.getElementById("dateTime").textContent = now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000); updateDateTime();

async function getIP(){
    const cache=sessionStorage.getItem("myIP");
    if(cache) return cache;
    try{
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        sessionStorage.setItem("myIP",data.ip);
        return data.ip;
    }catch{return "";}
}

// LIFF 初始化
async function updateUserInfo(){
    await liff.init({liffId:"2008549731-Zkv32GPr"});
    if(!liff.isLoggedIn()) await liff.login();
    const profile = await liff.getProfile();
    window.userId = profile.userId;
    window.userName = profile.displayName;

    document.getElementById("userInfo").textContent = `${window.userName} 您好`;

    // 取得管理者 IP
    await fetchAllowedIPs(window.userId);

    // 判斷是否管理者
    if(allowedIPs.length>0) document.getElementById("btnApprove").style.display="block";

    btnStart.disabled=false; btnEnd.disabled=false;
    window.userReady=true;
}

// 從後端取得管理者允許 IP
async function fetchAllowedIPs(userId){
    try{
        const res = await fetch(`${API_ENDPOINT}?action=getManagerIPs&userId=${userId}`);
        const data = await res.json();
        allowedIPs = data.ips || [];
    }catch(err){ console.error(err); allowedIPs=[]; }
}

// 管理者彈窗修改帳號密碼
document.getElementById("btnApprove").onclick = async function(){
    const { value: formValues } = await Swal.fire({
        title: '修改管理者帳號密碼',
        html:
        `<input id="swal-input1" class="swal2-input" placeholder="帳號 (第一次請填 admin)">
         <input id="swal-input2" class="swal2-input" placeholder="密碼 (16碼)" type="password">`,
        focusConfirm: false,
        preConfirm: () => {
            return [
                document.getElementById('swal-input1').value,
                document.getElementById('swal-input2').value
            ]
        }
    });

    if(!formValues) return;

    const [account,password] = formValues;

    // 首次登錄比對
    if(account===MANAGER_ACCOUNT && password===MANAGER_PASSWORD){
        const newAccount = prompt("請輸入新的管理者帳號：","");
        const newPassword = prompt("請輸入新的管理者密碼(16碼)：","");
        if(newAccount && newPassword){
            try{
                const res = await fetch(API_ENDPOINT,{
                    method:"POST",
                    body:JSON.stringify({
                        action:"updateManagerAccount",
                        userId: window.userId,
                        newAccount,
                        newPassword
                    })
                });
                const data = await res.json();
                if(data.success) Swal.fire("修改成功","已更新管理者帳號密碼","success");
                else Swal.fire("失敗","更新失敗","error");
            }catch(err){ Swal.fire("錯誤","網路或系統錯誤","error"); }
        }
    } else Swal.fire("錯誤","帳號或密碼錯誤","error");
};

// 判斷 IP 是否允許
async function isAllowedClockIn(){
    const ip = await getIP();
    return allowedIPs.includes(ip);
}

// 打卡功能
async function performClockIn(status){
    if(!window.userReady) return;

    const allowed = await isAllowedClockIn();
    if(!allowed){
        Swal.fire({icon:"error", title:"非公司網路", text:"您目前的網路不允許打卡"});
        return;
    }

    // 正常打卡請求
    try{
        const ip = await getIP();
        const res = await fetch(API_ENDPOINT,{
            method:"POST",
            body: JSON.stringify({
                userId: window.userId,
                displayName: window.userName,
                status,
                ip,
                isMakeup:false
            })
        });
        const data = await res.json();
        Swal.fire({icon:"success", title:"打卡成功", text:`時間：${data.date} ${data.time}`, timer:2000, showConfirmButton:false});
        updateTodayRecords();
    }catch(err){ Swal.fire("錯誤","打卡失敗","error"); console.error(err);}
}

// 今日打卡紀錄
async function updateTodayRecords(){
    const today = new Date().toISOString().split("T")[0].replace(/-/g,"/");
    try{
        const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${window.userId}&date=${today}`);
        const data = await res.json();
        const container = document.getElementById("todayRecords");
        if(!data.length) container.innerHTML="今日打卡紀錄：無";
        else container.innerHTML="今日打卡紀錄：<br>"+data.map(r=>`${r.status} ${r.time}`).join("<br>");
    }catch(err){ console.error(err);}
}

function clearSearch(){ document.getElementById("queryDate").value=""; updateTodayRecords(); }
async function searchDateRecords(){
    const dateInput=document.getElementById("queryDate").value;
    if(!dateInput){ updateTodayRecords(); return; }
    const parts=dateInput.split("-"); const dateStr=`${parts[0]}/${parts[1]}/${parts[2]}`;
    try{
        const res=await fetch(`${API_ENDPOINT}?action=getDate&userId=${window.userId}&date=${dateStr}`);
        const data=await res.json();
        const container=document.getElementById("todayRecords");
        if(!data.length){ container.innerHTML=`${dateStr}：無紀錄`; return; }
        container.innerHTML=`${dateStr} 打卡紀錄：<br>`+data.map(r=>`${r.status} ${r.time}`).join("<br>");
    }catch(err){ console.error(err);}
}

btnStart.onclick=()=>performClockIn("上班");
btnEnd.onclick=()=>performClockIn("下班");

window.onload = async ()=>{
    await updateUserInfo();
    await updateTodayRecords();
};
</script>
</body>
</html>



